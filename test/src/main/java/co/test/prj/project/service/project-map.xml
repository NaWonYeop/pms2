<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="co.test.prj.project.service.ProjectMapper">
			
	<select id="projectSelectList" resultType="co.test.prj.project.service.ProjectVO">
		SELECT * FROM PROJECT
	</select>
	
	<select id="projectSelect" parameterType="co.test.prj.project.service.ProjectVO"
		resultType="co.test.prj.project.service.ProjectVO">
		SELECT * 
		FROM PROJECT
		WHERE prj_id = #{prj_id}
	</select>
	
	<select id="projectMaxPId" parameterType="co.test.prj.project.service.ProjectVO" resultType="int">
		SELECT NVL(MAX(PRJ_ID) + 1, 1) AS ID FROM PROJECT
	</select>

	<insert id="projectInsert" parameterType="co.test.prj.project.service.ProjectVO">
			INSERT INTO PROJECT(PRJ_ID, PRJ_NAME, PRJ_STR, PRJ_ED, PRJ_OFR_PROP, 
			PRJ_FND_PROP, PRJ_CNT, MASTER_ID, CTF_ID, PRJ_OFR_STR, PRJ_OFR_ED,
			PRJ_FRN_PRS, PRJ_BK_PRS, PRJ_DB_PRS, PRJ_SER_PRS, PRJ_CND, PRJ_AR,
			PRJ_FND_STR, PRJ_FND_ED, PRJ_GL_PRC, PRJ_VER)
			VALUES(#{prj_id}, #{prj_name}, #{prj_str}, #{prj_ed}, #{prj_ofr_prop}, 
			#{prj_fnd_prop}, #{prj_cnt}, #{master_id}, #{ctf_id}, #{prj_ofr_str}, #{prj_ofr_ed},
			#{prj_frn_prs}, #{prj_bk_prs}, #{prj_db_prs}, #{prj_ser_prs}, #{prj_cnd}, #{prj_ar},
			#{prj_fnd_str}, #{prj_fnd_ed}, #{prj_gl_prc}, #{prj_ver})				
	</insert>
	
	<!-- 업데이트 지만 insert로 버전명 바꿔가면서 씀 -->
	<insert id="projectUpdate" parameterType="co.test.prj.project.service.ProjectVO">
	
	</insert>
	
	<update id="projectView" parameterType="co.test.prj.project.service.ProjectVO">	
		UPDATE PROJECT
		SET PRJ_VIEW_PROP = 1
		WHERE PRJ_ID = #{prj_id}
	</update>
	
	
	<delete id="projectDelete" parameterType="co.test.prj.project.service.ProjectVO">
	
	</delete>
	
	<!-- 구직상세 참여프로젝트 >>> 경일 -->
	<select id="jobJoinList" resultType="co.test.prj.project.service.ProjectVO">
		SELECT PRJ_NAME FROM PROJECT
		WHERE master_id = #{master_id} and SYSDATE <![CDATA[<]]> PRJ_OFR_ED
	</select>
	

	<!-- 구인현황 리스트 >>> 경일 -->
	<select id="ofterList" resultType="co.test.prj.user.service.UserVO">
		select u.user_name, u.user_crr, u.user_tel, app_stt
		from "user" u, application a
		where u.user_id in (select user_id from application where master_id=0 and prj_id = 0 ) and u.user_id=a.user_id;
	</select>

	
	<select id="projectSearchPageList" parameterType="co.test.prj.project.service.ProjectVO"
		resultType="co.test.prj.project.service.ProjectVO">
	<![CDATA[
		SELECT *
		FROM ( SELECT ROWNUM RN,
		            A.*
		                FROM ( ]]>
		                			SELECT p.*,c.ctf_usectf_st_course, c.ctf_st_name
									FROM PROJECT p JOIN COMTNFILE c
									ON(p.ctf_id = c.ctf_id)
									WHERE PRJ_VIEW_PROP = 0
									AND PRJ_NAME LIKE '%'||#{keyword}||'%'
									<choose>
										<when test="type != null and type.equals('ofr')">
											AND PRJ_OFR_PROP LIKE '1'
										</when>
										<when test="type != null and type.equals('fnd')">
											AND PRJ_FND_PROP LIKE '1'
										</when>
									</choose>
									ORDER BY PRJ_ID DESC
		            <![CDATA[ ) 
		            A )
		WHERE RN > ( #{pageNum} -1 )* #{amount} AND RN <= #{pageNum} * #{amount}
		]]>
	</select>
	
	<select id="projectSearchPageCount" parameterType="co.test.prj.project.service.ProjectVO"
		resultType="int">
		
		SELECT COUNT(*) AS TOTAL
		FROM PROJECT
		WHERE PRJ_NAME LIKE '%'||#{keyword}||'%'
		<choose>
			<when test="type != null and type.equals('ofr')">
				AND PRJ_OFR_PROP LIKE '1'
			</when>
			<when test="type != null and type.equals('fnd')">
				AND PRJ_FND_PROP LIKE '1'
			</when>
		</choose>
		ORDER BY PRJ_ID DESC
		
	</select>
	<!-- 원엽 -->
	<select id="mainOfrList" resultType="co.test.prj.project.service.ProjectVO">
	SELECT *
	FROM 
	(
		SELECT P.PRJ_NAME,P.PRJ_ID,COUNT(T.USER_ID) AS TOTAL_TEAM_PRS ,P.PRJ_OFR_STR,P.PRJ_OFR_ED,(P.PRJ_FRN_PRS+P.PRJ_BK_PRS+P.PRJ_DB_PRS+P.PRJ_SER_PRS ) AS TOTAL_PRS
		FROM PROJECT P LEFT OUTER JOIN TEAM T ON P.PRJ_ID=T.PRJ_ID
		WHERE P.PRJ_OFR_PROP=1
		GROUP BY P.PRJ_NAME,P.PRJ_ID,P.PRJ_OFR_STR,P.PRJ_OFR_ED,(P.PRJ_FRN_PRS+P.PRJ_BK_PRS+P.PRJ_DB_PRS+P.PRJ_SER_PRS )
		ORDER BY PRJ_ID DESC
	)
	WHERE ROWNUM <![CDATA[<]]>  4
	</select>
	
	<select id="mainFndList" resultType="co.test.prj.project.service.ProjectVO">
	SELECT *
	FROM 
	(
		SELECT P.PRJ_NAME,P.PRJ_ID,C.CTF_ST_NAME ,C.CTF_USECTF_ST_COURSE,TRUNC(P.PRJ_FND_ED-SYSDATE) AS PRJ_TIME,P.PRJ_FND_ED,P.PRJ_GL_PRC,NVL((SELECT SUM(RWD_PRC*RWD_COT) FROM REWARD R,PROJECT S WHERE R.PRJ_ID=S.PRJ_ID AND S.PRJ_ID=B.PRJ_ID),0) AS TOTAL
		FROM PROJECT P LEFT OUTER JOIN BUY B ON P.PRJ_ID=B.PRJ_ID, COMTNFILE C
		WHERE P.PRJ_FND_PROP=1 AND P.CTF_ID=C.CTF_ID
		ORDER BY PRJ_ID DESC
	)
	WHERE ROWNUM  <![CDATA[<]]> 4
	
	
	</select>
</mapper>